<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.engTest.mapper.QuestionMapper">

    <resultMap id="questionResultMap" type="com.example.engTest.dto.Question">
        <id property="id" column="id"/>
        <result property="roundId" column="round_id"/>
        <result property="questionType" column="question_type"/>
        <result property="answerType" column="answer_type"/>
        <result property="questionText" column="question_text"/>
        <result property="answer" column="answer"/>
        <result property="option1" column="option1"/>
        <result property="option2" column="option2"/>
        <result property="option3" column="option3"/>
        <result property="option4" column="option4"/>
        <result property="hint" column="hint"/>
        <result property="altAnswers" column="alt_answers"/>
        <result property="seqNo" column="seq_no"/>
        <result property="isReview" column="is_review"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="findByRoundId" resultMap="questionResultMap">
        SELECT * FROM questions WHERE round_id = #{roundId} ORDER BY is_review ASC, seq_no ASC
    </select>

    <select id="findById" resultMap="questionResultMap">
        SELECT * FROM questions WHERE id = #{id}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO questions (round_id, question_type, answer_type, question_text, answer, option1, option2, option3, option4, hint, alt_answers, seq_no, is_review)
        VALUES (#{roundId}, #{questionType}, #{answerType}, #{questionText}, #{answer}, #{option1}, #{option2}, #{option3}, #{option4}, #{hint}, #{altAnswers}, #{seqNo}, #{isReview})
    </insert>

    <insert id="insertBatch">
        INSERT INTO questions (round_id, question_type, answer_type, question_text, answer, option1, option2, option3, option4, hint, alt_answers, seq_no, is_review)
        VALUES
        <foreach collection="list" item="q" separator=",">
            (#{q.roundId}, #{q.questionType}, #{q.answerType}, #{q.questionText}, #{q.answer}, #{q.option1}, #{q.option2}, #{q.option3}, #{q.option4}, #{q.hint}, #{q.altAnswers}, #{q.seqNo}, #{q.isReview})
        </foreach>
    </insert>

    <update id="update">
        UPDATE questions SET
            question_type = #{questionType}, answer_type = #{answerType},
            question_text = #{questionText}, answer = #{answer},
            option1 = #{option1}, option2 = #{option2},
            option3 = #{option3}, option4 = #{option4},
            hint = #{hint}, alt_answers = #{altAnswers}, seq_no = #{seqNo}
        WHERE id = #{id}
    </update>

    <delete id="delete">
        DELETE FROM questions WHERE id = #{id}
    </delete>

    <delete id="deleteByRoundId">
        DELETE FROM questions WHERE round_id = #{roundId}
    </delete>

    <select id="countByRoundId" resultType="int">
        SELECT COUNT(*) FROM questions WHERE round_id = #{roundId}
    </select>

    <!-- 복습 문제용: 여러 회차의 문제 조회 -->
    <select id="findByRoundIds" resultMap="questionResultMap">
        SELECT * FROM questions WHERE round_id IN
        <foreach collection="roundIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND (is_review = FALSE OR is_review IS NULL)
    </select>

    <!-- 복습 문제만 삭제 -->
    <delete id="deleteReviewByRoundId">
        DELETE FROM questions WHERE round_id = #{roundId} AND is_review = TRUE
    </delete>

    <select id="getMaxSeqNo" resultType="int">
        SELECT COALESCE(MAX(seq_no), 0) FROM questions WHERE round_id = #{roundId}
    </select>

</mapper>
