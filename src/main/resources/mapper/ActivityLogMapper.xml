<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.engTest.mapper.ActivityLogMapper">

    <resultMap id="activityLogResult" type="com.example.engTest.dto.ActivityLog">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="action" column="action"/>
        <result property="targetType" column="target_type"/>
        <result property="targetId" column="target_id"/>
        <result property="details" column="details"/>
        <result property="ipAddress" column="ip_address"/>
        <result property="userAgent" column="user_agent"/>
        <result property="requestPath" column="request_path"/>
        <result property="httpMethod" column="http_method"/>
        <result property="responseStatus" column="response_status"/>
        <result property="durationMs" column="duration_ms"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <sql id="logFilterCondition">
        <where>
            <if test="userId != null">AND user_id = #{userId}</if>
            <if test="action != null and action != ''">AND action = #{action}</if>
            <if test="startDate != null">AND created_at >= #{startDate}</if>
            <if test="endDate != null">AND created_at &lt;= #{endDate}</if>
        </where>
    </sql>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO activity_logs (user_id, user_name, action, target_type, target_id, details,
            ip_address, user_agent, request_path, http_method, response_status, duration_ms)
        VALUES (#{userId}, #{userName}, #{action}, #{targetType}, #{targetId}, #{details},
            #{ipAddress}, #{userAgent}, #{requestPath}, #{httpMethod}, #{responseStatus}, #{durationMs})
    </insert>

    <select id="findAll" resultMap="activityLogResult">
        SELECT * FROM activity_logs
        <include refid="logFilterCondition"/>
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countAll" resultType="int">
        SELECT COUNT(*) FROM activity_logs
        <include refid="logFilterCondition"/>
    </select>

    <select id="findAllForExport" resultMap="activityLogResult">
        SELECT * FROM activity_logs
        <include refid="logFilterCondition"/>
        ORDER BY created_at DESC
    </select>

    <delete id="deleteOlderThan">
        DELETE FROM activity_logs WHERE created_at &lt; #{beforeDate}
    </delete>

    <select id="findDistinctActions" resultType="string">
        SELECT DISTINCT action FROM activity_logs ORDER BY action
    </select>

</mapper>
