<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ì˜ì–´ ì‹œí—˜ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ”§ ê´€ë¦¬ì í˜ì´ì§€</h1>
            <a href="/" class="btn-small">ë©”ì¸ìœ¼ë¡œ</a>
        </header>

        <main id="mainContent">
            <!-- ê´€ë¦¬ì ë©”ì¸ -->
            <div id="adminSection" class="section">
                <div class="admin-actions">
                    <button onclick="showCreateRound()" class="btn-primary">ìƒˆ íšŒì°¨ ìƒì„±</button>
                </div>
                <div id="adminRoundList" class="round-list"></div>
            </div>

            <!-- íšŒì°¨ ìƒì„± - 1ë‹¨ê³„: ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
            <div id="uploadImagesSection" class="section hidden">
                <div class="section-header">
                    <h2>1ë‹¨ê³„: ë‹¨ì–´ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
                    <button onclick="showAdminSection()" class="btn-secondary">ë’¤ë¡œ</button>
                </div>
                <div class="form-group">
                    <label>íšŒì°¨ ì œëª©</label>
                    <input type="text" id="roundTitle" placeholder="ì˜ˆ: 1íšŒì°¨ ë‹¨ì–´ ì‹œí—˜">
                </div>
                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="roundDescription" placeholder="ì‹œí—˜ì— ëŒ€í•œ ì„¤ëª…"></textarea>
                </div>
                <div class="form-group">
                    <label>ë‚œì´ë„</label>
                    <select id="difficulty">
                        <option value="EASY">ì‰¬ì›€ (ê°ê´€ì‹ 100%)</option>
                        <option value="MEDIUM" selected>ë³´í†µ (ê°ê´€ì‹ 30% + ì£¼ê´€ì‹ 70%)</option>
                        <option value="HARD">ì–´ë ¤ì›€ (ë¬¸ì¥ ì‘ìš© - ì£¼ê´€ì‹)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ë‹¨ì–´ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
                    <input type="file" id="wordImages" accept="image/*" multiple onchange="previewImages(this)">
                    <div id="imagePreviewArea" class="image-preview-area"></div>
                </div>
                <button onclick="extractWords()" class="btn-primary btn-large">ë‹¨ì–´ ì¶”ì¶œí•˜ê¸°</button>
                <p class="hint">* ì´ë¯¸ì§€ì—ì„œ ì˜ì–´ ë‹¨ì–´ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
            </div>

            <!-- íšŒì°¨ ìƒì„± - 2ë‹¨ê³„: ë‹¨ì–´ í™•ì¸/ìˆ˜ì • -->
            <div id="reviewWordsSection" class="section hidden">
                <div class="section-header">
                    <h2>2ë‹¨ê³„: ì¶”ì¶œëœ ë‹¨ì–´ í™•ì¸</h2>
                    <button onclick="showUploadImages()" class="btn-secondary">ë’¤ë¡œ</button>
                </div>
                <p class="hint">ì¶”ì¶œëœ ë‹¨ì–´ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”. ê° ì¤„ì— í•˜ë‚˜ì”©, "ì˜ì–´:í•œê¸€" í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•©ë‹ˆë‹¤.</p>
                <div class="form-group">
                    <textarea id="extractedWords" rows="15" placeholder="apple:ì‚¬ê³¼&#10;banana:ë°”ë‚˜ë‚˜"></textarea>
                </div>
                <button onclick="generateQuestions()" class="btn-success btn-large">ë¬¸ì œ ìƒì„±í•˜ê¸°</button>
            </div>

            <!-- íšŒì°¨ ìƒì„¸ ë³´ê¸° -->
            <div id="roundDetailSection" class="section hidden">
                <div class="section-header">
                    <h2 id="roundDetailTitle">íšŒì°¨ ìƒì„¸</h2>
                    <button onclick="showAdminSection()" class="btn-secondary">ë’¤ë¡œ</button>
                </div>
                <div id="roundQuestionsList" class="questions-list"></div>
                <div class="admin-actions">
                    <button onclick="deleteCurrentRound()" class="btn-danger">íšŒì°¨ ì‚­ì œ</button>
                </div>
            </div>
        </main>
    </div>

    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <p>ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <script>
        // ê´€ë¦¬ì í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸
        let currentRoundId = null;
        let extractedWordsList = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íšŒì°¨ ëª©ë¡ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadAdminRounds);

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showAdminSection() {
            showSection('adminSection');
            loadAdminRounds();
        }

        function showCreateRound() {
            showSection('uploadImagesSection');
            document.getElementById('roundTitle').value = '';
            document.getElementById('roundDescription').value = '';
            document.getElementById('wordImages').value = '';
            document.getElementById('imagePreviewArea').innerHTML = '';
        }

        function showUploadImages() {
            showSection('uploadImagesSection');
        }

        async function loadAdminRounds() {
            try {
                const response = await fetch('/api/rounds');
                const rounds = await response.json();

                const listHtml = rounds.length === 0
                    ? '<p class="empty-message">ìƒì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    : rounds.map(r => `
                        <div class="round-card" onclick="viewRoundDetail(${r.id})">
                            <h3>${r.title}</h3>
                            <p>${r.description || ''}</p>
                            <div class="round-meta">
                                <span>ë¬¸ì œ ìˆ˜: ${r.questionCount}</span>
                                <span>ë‚œì´ë„: ${r.difficulty}</span>
                                <span class="status-badge ${r.status.toLowerCase()}">${r.status}</span>
                            </div>
                        </div>
                    `).join('');

                document.getElementById('adminRoundList').innerHTML = listHtml;
            } catch (error) {
                console.error('Failed to load rounds:', error);
            }
        }

        function previewImages(input) {
            const previewArea = document.getElementById('imagePreviewArea');
            previewArea.innerHTML = '';

            if (input.files && input.files.length > 0) {
                for (const file of input.files) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.classList.add('preview-image');
                        previewArea.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        async function extractWords() {
            const title = document.getElementById('roundTitle').value.trim();
            const fileInput = document.getElementById('wordImages');

            if (!title) {
                alert('íšŒì°¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            showLoading();

            try {
                const formData = new FormData();
                for (const file of fileInput.files) {
                    formData.append('images', file);
                }

                // ìˆ¨ê²¨ì§„ í”„ë¡¬í”„íŠ¸ ì •ì˜
                const customPrompt = `ë‹¹ì‹ ì€ ì˜ì–´ í•™ìŠµ êµì¬ì—ì„œ ì˜ì–´ í‘œí˜„ì„ ì¶”ì¶œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì´ë¯¸ì§€ì—ì„œ ë‹¤ìŒ ê·œì¹™ì— ë”°ë¼ ì˜ì–´ í‘œí˜„ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”:

## ì¶”ì¶œ ê·œì¹™
1. **í•µì‹¬ í‘œí˜„ë§Œ ì¶”ì¶œ**:
   - ë°•ìŠ¤, í…Œì´ë¸”, ë¦¬ìŠ¤íŠ¸ ì•ˆì˜ í•µì‹¬ í‘œí˜„ë§Œ ì¶”ì¶œ
   - "ì˜ì–´í‘œí˜„:í•œê¸€ëœ»" ë˜ëŠ” "ì˜ì–´ë¬¸ì¥:í•œê¸€ë²ˆì—­" í˜•íƒœë¡œ ì¶”ì¶œ
   - ì§§ì€ ë‹¨ì–´/êµ¬/ë¬¸ì¥ë§Œ ì¶”ì¶œ (ê¸´ ë¬¸ë‹¨ ì œì™¸)

2. **ì œì™¸ í•­ëª©**:
   - í˜ì´ì§€ ì œëª©, ì„¹ì…˜ í—¤ë” (Day 01, Unit 01 ë“±)
   - ê¸´ ì„¤ëª… ë¬¸ë‹¨, ë¶€ì—° ì„¤ëª…
   - Tip ë°•ìŠ¤, ë¬¸ë²• ì„¤ëª…
   - ì˜ˆì‹œë¥¼ ì„¤ëª…í•˜ëŠ” ê¸´ ë¬¸ì¥

3. **ì¶œë ¥ í˜•ì‹**:
   - í•œ ì¤„ì— í•˜ë‚˜ì”©
   - "ì˜ì–´:í•œê¸€" í˜•íƒœ
   - ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ì¶”ì¶œëœ ë‚´ìš©ë§Œ
   - ì˜ì–´:í•œê¸€ í˜•íƒœê°€ ì•ˆë˜ëŠ” ê²½ìš° ì¶”ì¶œ ì œì™¸

ì˜ˆì‹œ ì¶œë ¥:
get a message:ë©”ì‹œì§€ë¥¼ ë°›ë‹¤
get a text:ë¬¸ìë¥¼ ë°›ë‹¤
live in:~ì— ì‚´ë‹¤
work in:~ì—ì„œ ì¼í•˜ë‹¤`;

                formData.append('prompt', customPrompt);

                const response = await fetch('/api/rounds/extract-words', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('ë‹¨ì–´ ì¶”ì¶œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                extractedWordsList = data.words || [];

                document.getElementById('extractedWords').value = extractedWordsList.join('\n');
                showSection('reviewWordsSection');
            } catch (error) {
                console.error('Failed to extract words:', error);
                alert('ë‹¨ì–´ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function generateQuestions() {
            const title = document.getElementById('roundTitle').value.trim();
            const description = document.getElementById('roundDescription').value.trim();
            const difficulty = document.getElementById('difficulty').value;
            const wordsText = document.getElementById('extractedWords').value.trim();

            if (!wordsText) {
                alert('ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const words = wordsText.split('\n').filter(w => w.trim());

            showLoading();

            try {
                // 1. íšŒì°¨ ìƒì„±
                const roundResponse = await fetch('/api/rounds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        questionCount: words.length,
                        difficulty: difficulty,
                        status: 'ACTIVE'
                    })
                });

                if (!roundResponse.ok) {
                    throw new Error('íšŒì°¨ ìƒì„± ì‹¤íŒ¨');
                }

                const round = await roundResponse.json();

                // 2. ë‹¨ì–´ ê¸°ë°˜ ë¬¸ì œ ìƒì„±
                const wordListStr = words.join('\n');

                // ë‚œì´ë„ë³„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì •ì˜
                const prompts = {
                    'EASY': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ **ê°ê´€ì‹ ë¬¸ì œë§Œ** ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ëœ»",
    "answer": "ì •ë‹µ ì˜ì–´ ë‹¨ì–´",
    "answerType": "CHOICE",
    "options": ["ì˜¤ë‹µ1", "ì˜¤ë‹µ2", "ì˜¤ë‹µ3"]
  }
]

ê·œì¹™:
1. ëª¨ë“  ë¬¸ì œëŠ” ê°ê´€ì‹ì…ë‹ˆë‹¤.
2. optionsì—ëŠ” ì •ë‹µê³¼ ë¹„ìŠ·í•œ ì˜¤ë‹µ 3ê°œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
3. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`,

                    'MEDIUM': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ **ê°ê´€ì‹ 30%, ì£¼ê´€ì‹ 70%** ë¹„ìœ¨ë¡œ ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ëœ» ë˜ëŠ” ë¬¸ì¥",
    "answer": "ì •ë‹µ ì˜ì–´",
    "answerType": "CHOICE" ë˜ëŠ” "TEXT",
    "options": ["ì˜¤ë‹µ1", "ì˜¤ë‹µ2", "ì˜¤ë‹µ3"] (ê°ê´€ì‹ì¼ ë•Œë§Œ)
  }
]

ê·œì¹™:
1. ê°ê´€ì‹(CHOICE)ê³¼ ì£¼ê´€ì‹(TEXT)ë¥¼ ì„ì–´ì£¼ì„¸ìš”.
2. ì£¼ê´€ì‹ì€ optionsë¥¼ ë¹ˆ ë°°ì—´ë¡œ ë‘ì„¸ìš”.
3. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`,

                    'HARD': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ **ì‘ìš©í•œ ê°„ë‹¨í•œ ì˜ì–´ ë¬¸ì¥ ë¬¸ì œ**ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ë¬¸ì¥ (ë²ˆì—­í•  ë¬¸ì¥)",
    "answer": "ì •ë‹µ ì˜ì–´ ë¬¸ì¥",
    "answerType": "TEXT",
    "options": []
  }
]

ê·œì¹™:
1. ëª¨ë“  ë¬¸ì œëŠ” ì£¼ê´€ì‹ì…ë‹ˆë‹¤.
2. ë‹¨ì–´ë“¤ì„ í™œìš©í•œ ê°„ë‹¨í•œ ë¬¸ì¥ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
3. optionsëŠ” ë¹ˆ ë°°ì—´ë¡œ ë‘ì„¸ìš”.
4. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`
                };

                const prompt = prompts[difficulty] || prompts['MEDIUM'];

                const generateResponse = await fetch(`/api/rounds/${round.id}/generate-from-words`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        words: words,
                        difficulty: difficulty,
                        prompt: prompt
                    })
                });

                if (!generateResponse.ok) {
                    throw new Error('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨');
                }

                const result = await generateResponse.json();
                alert(`${result.count}ê°œì˜ ë¬¸ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);

                showAdminSection();
            } catch (error) {
                console.error('Failed to generate questions:', error);
                alert('ë¬¸ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function viewRoundDetail(roundId) {
            currentRoundId = roundId;
            showLoading();

            try {
                const [roundRes, questionsRes] = await Promise.all([
                    fetch(`/api/rounds/${roundId}`),
                    fetch(`/api/rounds/${roundId}/questions`)
                ]);

                const round = await roundRes.json();
                const questions = await questionsRes.json();

                document.getElementById('roundDetailTitle').textContent = round.title;

                const questionsHtml = questions.length === 0
                    ? '<p class="empty-message">ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    : questions.map((q, i) => `
                        <div class="question-card">
                            <div class="question-number">${i + 1}ë²ˆ</div>
                            <div class="question-content">
                                <p class="question-text">${q.questionText}</p>
                                <p class="answer"><strong>ì •ë‹µ:</strong> ${q.answer}</p>
                                ${q.answerType === 'CHOICE' ? `
                                    <div class="options">
                                        <span>â‘  ${q.option1 || ''}</span>
                                        <span>â‘¡ ${q.option2 || ''}</span>
                                        <span>â‘¢ ${q.option3 || ''}</span>
                                        <span>â‘£ ${q.option4 || ''}</span>
                                    </div>
                                ` : '<span class="badge">ì£¼ê´€ì‹</span>'}
                            </div>
                        </div>
                    `).join('');

                document.getElementById('roundQuestionsList').innerHTML = questionsHtml;
                showSection('roundDetailSection');
            } catch (error) {
                console.error('Failed to load round detail:', error);
            } finally {
                hideLoading();
            }
        }

        async function deleteCurrentRound() {
            if (!currentRoundId) return;

            if (!confirm('ì •ë§ ì´ íšŒì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showLoading();

            try {
                await fetch(`/api/rounds/${currentRoundId}`, { method: 'DELETE' });
                alert('íšŒì°¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                showAdminSection();
            } catch (error) {
                console.error('Failed to delete round:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>

</html>