<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ì˜ì–´ ì‹œí—˜ ì‹œìŠ¤í…œ</title>
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="EstellExam Admin">
    <meta property="og:description" content="Administrator dashboard for EstellExam system.">
    <meta property="og:image" content="/images/og-image.png">
    <meta property="og:type" content="website">

    <!-- Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css?v=3">
</head>

<body>
    <div class="app-layout">
        <div id="sidebarOverlay" class="sidebar-overlay hidden" onclick="toggleSidebar()"></div>
        <nav class="sidebar" id="mainSidebar">
            <div class="sidebar-header">
                <div class="logo-area" onclick="location.href='/'">
                    <div class="logo-icon"><i class="fa-solid fa-layer-group"></i></div>
                    <span class="logo-text">EstellExam</span>
                </div>
            </div>
            <ul class="nav-links">
                <li class="nav-item" onclick="location.href='/'">
                    <i class="fa-solid fa-house"></i><span>Dashboard</span>
                </li>
                <li class="nav-item active" onclick="location.reload()">
                    <i class="fa-solid fa-gear"></i><span>Admin</span>
                </li>
            </ul>
        </nav>
        <main class="main-content">
            <header class="top-header" style="flex-wrap: nowrap;">
                <div class="header-title" style="display:flex; align-items:center; gap:10px;">
                    <button class="clay-btn btn-secondary btn-small" id="headerCloseBtn" onclick="location.href='/'"><i
                            class="fa-solid fa-arrow-left"></i> Close</button>
                    <div class="header-left-mobile mobile-only"
                        style="display:none; align-items:center; gap:10px; margin-right:10px;">
                        <i class="fa-solid fa-bars" style="font-size:1.1rem; cursor:pointer; color:var(--text-main);"
                            onclick="toggleSidebar()"></i>
                        <div class="logo-area-mobile"
                            style="font-size:1rem; font-weight:900; color:var(--text-main); display:flex; align-items:center; gap:8px;">
                            <i class="fa-solid fa-layer-group" style="color:var(--primary);"></i><span>Admin</span>
                        </div>
                    </div>
                </div>
                <div class="header-right" style="display:flex; align-items:center; gap:20px;">
                    <div class="theme-toggle-header" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <i id="themeIcon" class="fa-solid fa-moon"></i>
                    </div>
                    <div class="user-profile-container" id="userProfileArea">
                        <div class="user-profile" onclick="toggleProfileMenu(event)">
                            <div class="avatar-circle">
                                <i class="fa-solid fa-user-shield"></i>
                            </div>
                            <span id="headerUserName" class="pc-only">Admin</span>
                            <i class="fa-solid fa-caret-down"></i>
                        </div>
                        <div class="profile-dropdown hidden" id="profileDropdown">
                            <div class="dropdown-item" onclick="location.href='/'">
                                <i class="fa-solid fa-right-from-bracket" style="color: var(--danger);"></i> Exit
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="container" style="padding-top:20px; height:auto; overflow:visible;">
                <main id="mainContent">
                    <!-- ê´€ë¦¬ì ë©”ì¸ -->
                    <div id="adminSection" class="section">
                        <div class="admin-actions">
                            <button onclick="showCreateRound()" class="btn-primary">ìƒˆ íšŒì°¨ ìƒì„±</button>
                        </div>
                        <div id="adminRoundList" class="round-list"></div>
                    </div>

                    <!-- íšŒì°¨ ìƒì„± (ê°„ì†Œí™”) -->
                    <div id="createRoundSection" class="section hidden">
                        <div class="section-header">
                            <h2>ìƒˆ íšŒì°¨ ìƒì„±</h2>
                            <button onclick="showAdminSection()" class="btn-secondary">ë’¤ë¡œ</button>
                        </div>
                        <div class="form-group">
                            <label>íšŒì°¨ ì œëª©</label>
                            <input type="text" id="roundTitle" placeholder="ì˜ˆ: 1íšŒì°¨ ë‹¨ì–´ ì‹œí—˜" class="clay-input">
                        </div>
                        <div class="form-group">
                            <label>ì„¤ëª…</label>
                            <textarea id="roundDescription" placeholder="ì‹œí—˜ì— ëŒ€í•œ ì„¤ëª…" class="clay-input"></textarea>
                        </div>
                        <button onclick="createRound()" class="btn-primary btn-large">ìƒì„±í•˜ê¸°</button>
                    </div>

                    <!-- íšŒì°¨ ìƒì„¸ ë³´ê¸° -->
                    <div id="roundDetailSection" class="section hidden">
                        <div class="section-header" style="flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <h2 id="roundDetailTitle">íšŒì°¨ ìƒì„¸</h2>
                                <span id="roundStatusBadge" class="status-badge closed">CLOSED</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button id="btnActivate" onclick="activateRound()" class="btn-success"
                                    style="display:none;">
                                    <i class="fa-solid fa-play"></i> í™œì„±í™”
                                </button>
                                <button id="btnClose" onclick="closeRound()" class="btn-warning" style="display:none;">
                                    <i class="fa-solid fa-stop"></i> ì¢…ë£Œ
                                </button>
                                <button onclick="showAdminSection()" class="btn-secondary">ë’¤ë¡œ</button>
                            </div>
                        </div>

                        <!-- íƒ­ ë©”ë‰´ -->
                        <div class="tab-menu">
                            <button class="tab-btn active" onclick="switchTab('vocabulary', this)">ë‹¨ì–´ ì…ë ¥</button>
                            <button class="tab-btn" onclick="switchTab('materials', this)">êµìœ¡ìë£Œ</button>
                        </div>

                        <!-- ë‹¨ì–´ ì…ë ¥ íƒ­ -->
                        <div id="vocabularyTab" class="tab-content active">
                            <!-- ë‹¨ì–´ ëª©ë¡ (ì•„ì½”ë””ì–¸) -->
                            <div class="study-accordion-item active" id="vocabListAccordion">
                                <div class="study-accordion-header"
                                    onclick="toggleAdminAccordion('vocabListAccordion')">
                                    <span>ğŸ“‹ ë“±ë¡ëœ ë‹¨ì–´ ëª©ë¡</span>
                                    <i class="fa-solid fa-chevron-down arrow-icon"></i>
                                </div>
                                <div class="study-accordion-content">
                                    <div id="vocabularyList" class="vocabulary-list">
                                        <p class="empty-message">ë“±ë¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 2ë‹¨ ê·¸ë¦¬ë“œ: ìˆ˜ë™ ì…ë ¥ + ì´ë¯¸ì§€ ì¶”ì¶œ -->
                            <div class="two-column-grid">
                                <!-- ìˆ˜ë™ ë‹¨ì–´ ì…ë ¥ -->
                                <div class="material-add-section">
                                    <h3>âœï¸ ìˆ˜ë™ ë‹¨ì–´ ì…ë ¥</h3>
                                    <div class="manual-input-header"
                                        style="display:flex; gap:10px; margin-bottom:5px; padding:0 12px;">
                                        <span
                                            style="flex:1; font-size:0.8rem; font-weight:700; color:var(--text-muted);">ENGLISH</span>
                                        <span
                                            style="flex:1; font-size:0.8rem; font-weight:700; color:var(--text-muted);">KOREAN</span>
                                        <span style="width:30px;"></span>
                                    </div>
                                    <div class="form-group">
                                        <div id="manualInputList" class="manual-input-list">
                                            <!-- Dynamic Input Rows will be added here -->
                                        </div>
                                        <button onclick="addInputRow()" class="btn-secondary btn-small"
                                            style="width:100%; margin-top:10px; border: 1px dashed var(--primary); background: transparent; color: var(--primary);">
                                            <i class="fa-solid fa-plus"></i> ë‹¨ì–´ ì¶”ê°€
                                        </button>
                                    </div>
                                    <button onclick="saveManualWords()" class="btn-primary" style="width:100%;">ë‹¨ì–´
                                        ì €ì¥</button>
                                </div>

                                <!-- ì´ë¯¸ì§€ë¡œ ë‹¨ì–´ ì¶”ì¶œ -->
                                <div class="material-add-section">
                                    <h3>ğŸ–¼ï¸ ì´ë¯¸ì§€ì—ì„œ ë‹¨ì–´ ì¶”ì¶œ</h3>
                                    <div class="file-upload-wrapper">
                                        <input type="file" id="wordImages" accept="image/*" multiple
                                            onchange="previewImages(this)" class="hidden-file-input">
                                        <label for="wordImages" class="file-upload-label clay-card-upload"
                                            id="imageDropZone">
                                            <div class="upload-icon-circle">
                                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                            </div>
                                            <span class="upload-primary-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span>
                                            <span class="upload-secondary-text">ë˜ëŠ” íŒŒì¼ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                                        </label>
                                    </div>
                                    <div id="imagePreviewArea" class="image-preview-area"></div>
                                    <button onclick="extractWordsFromImages()" class="btn-primary"
                                        style="width:100%; margin-top:15px;">ì´ë¯¸ì§€ì—ì„œ ë‹¨ì–´ ì¶”ì¶œ</button>
                                </div>
                            </div>

                            <!-- ë¬¸ì œ ìƒì„± ì˜ì—­ -->
                            <div class="material-add-section"
                                style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid var(--primary);">
                                <h3>ğŸš€ ë¬¸ì œ ìƒì„±</h3>
                                <p class="hint">ìœ„ì—ì„œ ì…ë ¥/ì¶”ì¶œí•œ ë‹¨ì–´ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ì‹œí—˜ ë¬¸ì œë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.</p>
                                <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                                    <div class="form-group" style="flex:1; min-width: 150px;">
                                        <label for="difficulty">ë‚œì´ë„</label>

                                        <!-- Custom Clay Select -->
                                        <div class="custom-select-wrapper" id="difficultySelectWrapper">
                                            <div class="custom-select-trigger" onclick="toggleVocabularyDifficulty()">
                                                <span id="difficultyText">ì¤‘ê¸‰ (ì£¼ê´€ì‹)</span>
                                                <i class="fa-solid fa-chevron-down arrow"></i>
                                            </div>
                                            <div class="custom-options hidden" id="difficultyOptions">
                                                <div class="custom-option" data-value="EASY"
                                                    onclick="selectVocabularyDifficulty('EASY', 'ì´ˆê¸‰ (ê°ê´€ì‹)')">
                                                    <span>ì´ˆê¸‰ (ê°ê´€ì‹)</span>
                                                </div>
                                                <div class="custom-option selected" data-value="MEDIUM"
                                                    onclick="selectVocabularyDifficulty('MEDIUM', 'ì¤‘ê¸‰ (ì£¼ê´€ì‹)')">
                                                    <span>ì¤‘ê¸‰ (ì£¼ê´€ì‹)</span>
                                                </div>
                                                <div class="custom-option" data-value="HARD"
                                                    onclick="selectVocabularyDifficulty('HARD', 'ê³ ê¸‰ (ë¬¸ì¥ ì‘ìš©)')">
                                                    <span>ê³ ê¸‰ (ë¬¸ì¥ ì‘ìš©)</span>
                                                </div>
                                            </div>
                                            <input type="hidden" id="difficultyValue" value="MEDIUM">
                                        </div>
                                    </div>
                                    <div class="form-group" style="min-width: 100px;">
                                        <label for="questionCount">ë¬¸ì œ ìˆ˜</label>
                                        <input type="number" id="questionCount" value="30" min="1" class="clay-input"
                                            style="width: 80px; text-align: center;" oninput="onQuestionCountChange()">
                                    </div>
                                    <div class="form-group" style="min-width: 100px;">
                                        <label for="passScore">í•©ê²© ì ìˆ˜</label>
                                        <input type="number" id="passScore" value="24" min="1" class="clay-input"
                                            style="width: 80px; text-align: center;">
                                    </div>
                                    <button onclick="generateQuestionsFromVocabulary()" class="btn-success"
                                        style="height:fit-content;">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> ìƒì„±
                                    </button>
                                </div>
                            </div>

                            <script>
                                function toggleVocabularyDifficulty() {
                                    const options = document.getElementById('difficultyOptions');
                                    options.classList.toggle('hidden');
                                }

                                function selectVocabularyDifficulty(value, text) {
                                    document.getElementById('difficultyValue').value = value;
                                    document.getElementById('difficultyText').textContent = text;

                                    // Visual selection update
                                    const wrapper = document.getElementById('difficultySelectWrapper');
                                    const allOptions = wrapper.querySelectorAll('.custom-option');
                                    allOptions.forEach(opt => opt.classList.remove('selected'));

                                    const selectedOption = wrapper.querySelector(`.custom-option[data-value="${value}"]`);
                                    if (selectedOption) selectedOption.classList.add('selected');

                                    document.getElementById('difficultyOptions').classList.add('hidden');
                                }

                                // Close dropdown when clicking outside
                                document.addEventListener('click', function (e) {
                                    const wrapper = document.getElementById('difficultySelectWrapper');
                                    if (wrapper && !wrapper.contains(e.target)) {
                                        document.getElementById('difficultyOptions').classList.add('hidden');
                                    }
                                });

                                // Toggle Admin Accordion
                                function toggleAdminAccordion(id) {
                                    const item = document.getElementById(id);
                                    if (item) {
                                        item.classList.toggle('active');
                                    }
                                }
                            </script>
                        </div>

                        <!-- êµìœ¡ìë£Œ íƒ­ -->
                        <div id="materialsTab" class="tab-content hidden">
                            <div class="material-add-section">
                                <h3>ğŸ“º ìœ íŠœë¸Œ ì˜ìƒ ì¶”ê°€</h3>
                                <div class="form-row">
                                    <input type="text" id="youtubeTitle" placeholder="ì˜ìƒ ì œëª© (ì„ íƒ)">
                                    <input type="text" id="youtubeUrl" placeholder="ìœ íŠœë¸Œ URL">
                                    <button type="button" onclick="addYoutubeMaterial()" class="btn-primary">ì¶”ê°€</button>
                                </div>
                            </div>
                            <div class="material-add-section">
                                <h3>ğŸ“„ PDF ìë£Œ ì—…ë¡œë“œ</h3>
                                <input type="text" id="pptTitle" placeholder="ìë£Œ ì œëª© (ì„ íƒ)" class="clay-input"
                                    style="margin-bottom: 15px;">
                                <div class="file-upload-wrapper">
                                    <input type="file" id="pptFile" accept=".pdf" class="hidden-file-input">
                                    <label for="pptFile" class="file-upload-label clay-card-upload" id="pptDropZone">
                                        <div class="upload-icon-circle">
                                            <i class="fa-solid fa-file-arrow-up"></i>
                                        </div>
                                        <span class="upload-primary-text">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</span>
                                        <span class="upload-secondary-text">ë˜ëŠ” íŒŒì¼ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                                        <span class="upload-file-name" id="pptFileName"></span>
                                    </label>
                                </div>
                                <button type="button" onclick="addPptMaterial()" class="btn-primary"
                                    style="margin-top: 15px; width: 100%;">ì—…ë¡œë“œ</button>
                            </div>
                            <div class="material-list-section">
                                <h3>ğŸ“‹ ë“±ë¡ëœ êµìœ¡ìë£Œ</h3>
                                <div id="materialsList"></div>
                            </div>
                        </div>

                        <div class="admin-actions" style="margin-top: 30px;">
                            <button onclick="deleteCurrentRound()" class="btn-danger">íšŒì°¨ ì‚­ì œ</button>
                        </div>
                    </div>
                </main>
            </div>
        </main>
    </div>

    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <p>ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <script>
        // Layout Utilities
        function toggleSidebar() {
            const sb = document.getElementById('mainSidebar'); if (sb) sb.classList.toggle('active');
            const ov = document.getElementById('sidebarOverlay'); if (ov) ov.classList.toggle('hidden');
        }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }
        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            if (document.body.classList.contains('dark-mode')) { icon.className = 'fa-solid fa-sun'; icon.style.color = '#fbbf24'; }
            else { icon.className = 'fa-solid fa-moon'; icon.style.color = ''; }
        }
        function toggleProfileMenu(e) {
            if (e) e.stopPropagation();
            document.getElementById('profileDropdown').classList.toggle('hidden');
        }
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); updateThemeIcon(); }
            window.addEventListener('click', (e) => {
                const dd = document.getElementById('profileDropdown');
                const pa = document.getElementById('userProfileArea');
                if (dd && !dd.classList.contains('hidden') && pa && !pa.contains(e.target)) dd.classList.add('hidden');
            });
        });

        // ===== ê´€ë¦¬ì í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ =====
        let currentRoundId = null;
        let currentRoundData = null;
        let vocabData = [];

        document.addEventListener('DOMContentLoaded', loadAdminRounds);

        function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showAdminSection() {
            showSection('adminSection');
            loadAdminRounds();
        }

        function showCreateRound() {
            showSection('createRoundSection');
            document.getElementById('roundTitle').value = '';
            document.getElementById('roundDescription').value = '';
            document.getElementById('difficulty').value = 'MEDIUM';
        }

        async function loadAdminRounds() {
            try {
                const response = await fetch('/api/rounds');
                const rounds = await response.json();

                const listHtml = rounds.length === 0
                    ? '<p class="empty-message">ìƒì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    : rounds.map(r => `
                        <div class="round-card" onclick="viewRoundDetail(${r.id})">
                            <h3>${r.title}</h3>
                            <p>${r.description || ''}</p>
                            <div class="round-meta">
                                <span>ë¬¸ì œ ìˆ˜: ${r.questionCount}</span>
                                <span>ë‚œì´ë„: ${r.difficulty}</span>
                                <span class="status-badge ${r.status.toLowerCase()}">${r.status}</span>
                            </div>
                        </div>
                    `).join('');

                document.getElementById('adminRoundList').innerHTML = listHtml;
            } catch (error) {
                console.error('Failed to load rounds:', error);
            }
        }

        // ===== íšŒì°¨ ìƒì„± =====
        async function createRound() {
            const title = document.getElementById('roundTitle').value.trim();
            const description = document.getElementById('roundDescription').value.trim();

            if (!title) {
                alert('íšŒì°¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            showLoading();
            try {
                const response = await fetch('/api/rounds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        questionCount: 0,
                        difficulty: 'MEDIUM',
                        status: 'CLOSED'
                    })
                });

                if (!response.ok) throw new Error('íšŒì°¨ ìƒì„± ì‹¤íŒ¨');

                const round = await response.json();
                alert('íšŒì°¨ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                viewRoundDetail(round.id);
            } catch (error) {
                console.error('Failed to create round:', error);
                alert('íšŒì°¨ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ===== íšŒì°¨ ìƒì„¸ =====
        async function viewRoundDetail(roundId) {
            currentRoundId = roundId;
            showLoading();

            try {
                const [roundRes, vocabRes] = await Promise.all([
                    fetch(`/api/rounds/${roundId}`),
                    fetch(`/api/rounds/${roundId}/vocabulary`)
                ]);

                currentRoundData = await roundRes.json();
                const vocabulary = await vocabRes.json();

                document.getElementById('roundDetailTitle').textContent = currentRoundData.title;
                renderVocabularyList(vocabulary);
                updateRoundStatusUI(currentRoundData.status);

                // íƒ­ ì´ˆê¸°í™”
                switchTab('vocabulary', document.querySelector('.tab-btn'));
                showSection('roundDetailSection');
            } catch (error) {
                console.error('Failed to load round detail:', error);
            } finally {
                hideLoading();
            }
        }

        function updateRoundStatusUI(status) {
            const badge = document.getElementById('roundStatusBadge');
            const btnActivate = document.getElementById('btnActivate');
            const btnClose = document.getElementById('btnClose');

            badge.textContent = status;
            badge.className = 'status-badge ' + status.toLowerCase();

            // Show/hide buttons based on status
            if (status === 'CLOSED') {
                btnActivate.style.display = 'inline-flex';
                btnClose.style.display = 'none';
            } else if (status === 'ACTIVE') {
                btnActivate.style.display = 'none';
                btnClose.style.display = 'inline-flex';
            } else {
                // COMPLETED
                btnActivate.style.display = 'none';
                btnClose.style.display = 'none';
            }
        }

        async function activateRound() {
            if (!confirm('ì´ íšŒì°¨ë¥¼ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚¬ìš©ìê°€ ì‹œí—˜ì„ ë³¼ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.')) return;
            await updateRoundStatus('ACTIVE');
        }

        async function closeRound() {
            if (!confirm('ì´ íšŒì°¨ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë” ì´ìƒ ì‹œí—˜ì„ ë³¼ ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.')) return;
            await updateRoundStatus('CLOSED');
        }

        async function updateRoundStatus(newStatus) {
            showLoading();
            try {
                const response = await fetch(`/api/rounds/${currentRoundId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!response.ok) throw new Error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');

                currentRoundData.status = newStatus;
                updateRoundStatusUI(newStatus);
                alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Failed to update status:', error);
                alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        function renderVocabularyList(vocabulary) {
            vocabData = vocabulary || [];
            const listEl = document.getElementById('vocabularyList');
            if (!vocabulary || vocabulary.length === 0) {
                listEl.innerHTML = '<p class="empty-message">ë“±ë¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listEl.innerHTML = `
                <div class="vocab-table-container">
                    <table class="vocab-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>English</th>
                                <th>Korean</th>
                                <th>Phonetic</th>
                                <th style="width: 80px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vocabularyListBody">
                            ${vocabulary.map((v, index) => `
                                <tr>
                                    <td><span style="color:var(--text-muted); font-weight:bold;">${index + 1}</span></td>
                                    <td><span style="font-weight:600; color:var(--text-primary);">${v.english}</span></td>
                                    <td>${v.korean || ''}</td>
                                    <td><span class="phonetic-text">${v.phonetic || '-'}</span></td>
                                    <td style="text-align: center;">
                                        <button onclick="deleteWord(${v.id})" class="btn-icon-delete" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                    <span class="clay-card" style="padding:5px 15px; font-size:0.85rem; color:var(--text-muted); background:#fff;">
                        Total Words: <strong style="color:var(--primary);">${vocabulary.length}</strong>
            `;

            // ë‹¨ì–´ ëª©ë¡ ê°œìˆ˜ì— ë§ì¶° ë¬¸ì œ ìˆ˜ì™€ í•©ê²© ì ìˆ˜ ê¸°ë³¸ê°’ ê°±ì‹ 
            updateQuestionDefaults(vocabulary.length);
        }

        // ===== ë¬¸ì œ ìˆ˜ / í•©ê²© ì ìˆ˜ ê¸°ë³¸ê°’ ë™ì  ê°±ì‹  =====
        function updateQuestionDefaults(wordCount) {
            const questionCountInput = document.getElementById('questionCount');
            const passScoreInput = document.getElementById('passScore');

            if (!questionCountInput || !passScoreInput) return;

            // ë¬¸ì œ ìˆ˜: ë‹¨ì–´ ê°œìˆ˜ (ìµœëŒ€ 30ê°œë¡œ ì´ˆê¸°ê°’ ì„¤ì •, ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë” ë†’ì¼ ìˆ˜ ìˆìŒ)
            const questionCount = Math.min(wordCount, 30);
            questionCountInput.value = questionCount;

            // í•©ê²© ì ìˆ˜: ë¬¸ì œ ìˆ˜ì˜ 80%
            const passScore = Math.ceil(questionCount * 0.8);
            passScoreInput.value = passScore;
        }

        // ===== ë¬¸ì œ ìˆ˜ ë³€ê²½ ì‹œ í•©ê²© ì ìˆ˜ ìë™ ê³„ì‚° =====
        function onQuestionCountChange() {
            const questionCountInput = document.getElementById('questionCount');
            const passScoreInput = document.getElementById('passScore');

            if (!questionCountInput || !passScoreInput) return;

            const questionCount = parseInt(questionCountInput.value) || 0;
            const passScore = Math.ceil(questionCount * 0.8);
            passScoreInput.value = passScore;
        }

        // ===== ìˆ˜ë™ ë‹¨ì–´ ì…ë ¥ UI ê´€ë¦¬ =====
        function addInputRow() {
            const list = document.getElementById('manualInputList');
            const div = document.createElement('div');
            div.className = 'manual-input-row';
            div.innerHTML = `
        <input type="text" class="input-english" placeholder="English (e.g. apple)">
        <input type="text" class="input-korean" placeholder="Korean (e.g. ì‚¬ê³¼)">
        <button onclick="removeInputRow(this)" class="btn-icon-delete-small" tabindex="-1"><i class="fa-solid fa-xmark"></i></button>
    `;
            list.appendChild(div);
            // Focus on the first input of the new row
            div.querySelector('.input-english').focus();
        }

        function removeInputRow(btn) {
            const row = btn.closest('.manual-input-row');
            row.remove();
        }

        // ===== ìˆ˜ë™ ë‹¨ì–´ ì €ì¥ =====
        async function saveManualWords() {
            const rows = document.querySelectorAll('.manual-input-row');
            if (rows.length === 0) {
                alert('ì…ë ¥ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }

            const words = [];
            rows.forEach(row => {
                const eng = row.querySelector('.input-english').value.trim();
                const kor = row.querySelector('.input-korean').value.trim();
                if (eng && kor) {
                    words.push(`${eng}:${kor}`);
                }
            });

            if (words.length === 0) {
                alert('ì˜ì–´ì™€ í•œê¸€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/rounds/${currentRoundId}/vocabulary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(words)
                });

                if (!response.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');

                document.getElementById('manualInputList').innerHTML = ''; // Clear inputs
                addInputRow(); // Add one empty row back
                alert(`${words.length}ê°œ ë‹¨ì–´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // ë‹¨ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                const vocabRes = await fetch(`/api/rounds/${currentRoundId}/vocabulary`);
                const vocabulary = await vocabRes.json();
                renderVocabularyList(vocabulary);
            } catch (error) {
                console.error('Failed to save words:', error);
                alert('ë‹¨ì–´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ===== ì´ë¯¸ì§€ì—ì„œ ë‹¨ì–´ ì¶”ì¶œ =====
        function previewImages(input) {
            const previewArea = document.getElementById('imagePreviewArea');
            previewArea.innerHTML = '';

            if (input.files && input.files.length > 0) {
                for (const file of input.files) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.classList.add('preview-image');
                        previewArea.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }



        async function extractWordsFromImages() {
            const fileInput = document.getElementById('wordImages');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            showLoading();

            try {
                const formData = new FormData();
                for (const file of fileInput.files) {
                    formData.append('images', file);
                }

                const customPrompt = `ë‹¹ì‹ ì€ ì˜ì–´ í•™ìŠµ êµì¬ì—ì„œ ì˜ì–´ í‘œí˜„ì„ ì¶”ì¶œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

## [ì¤‘ìš”] ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì¶”ì¶œ
- **ì ˆëŒ€ë¡œ ëœ»ì„ ìœ ì¶”í•˜ê±°ë‚˜ ë²ˆì—­í•˜ì§€ ë§ˆì„¸ìš”.**
- ì´ë¯¸ì§€ì— ë³´ì´ëŠ” í…ìŠ¤íŠ¸ë¥¼ **ìˆëŠ” ê·¸ëŒ€ë¡œ** ì¶”ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
- ì˜ˆ: ì´ë¯¸ì§€ì— "ìƒˆ ì»´í“¨í„°ë¥¼ ì¥ë§Œí•˜ë‹¤"ë¼ê³  ì í˜€ìˆìœ¼ë©´, "ìƒˆ ì»´í“¨í„°ë¥¼ ì‚¬ë‹¤"ë¡œ ë°”ê¾¸ë©´ ì•ˆ ë©ë‹ˆë‹¤.

## [ì¤‘ìš”] ë²ˆí˜¸ ë§¤ì¹­ ë° ë³‘í•©
- ì—¬ëŸ¬ ì´ë¯¸ì§€ê°€ ì œê³µë˜ë©´, ì´ë“¤ì€ **ê°™ì€ ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸**ì˜ ì„œë¡œ ë‹¤ë¥¸ í˜ì´ì§€ì…ë‹ˆë‹¤.
- **ë²ˆí˜¸(1, 2, 3...)ê°€ ê°™ì€ í•­ëª©ë¼ë¦¬ ë§¤ì¹­**í•˜ì—¬ "ì˜ì–´:í•œê¸€" ìŒì„ ë§Œë“œì„¸ìš”.
- ì˜ˆ: ì´ë¯¸ì§€Aì˜ "1. get a message"ì™€ ì´ë¯¸ì§€Bì˜ "1. ë©”ì‹œì§€ë¥¼ ë°›ë‹¤" â†’ "get a message:ë©”ì‹œì§€ë¥¼ ë°›ë‹¤"
- **ì¤‘ë³µ ì¶œë ¥ ê¸ˆì§€**: ê°™ì€ ë²ˆí˜¸ì— ëŒ€í•´ ë‘ ì¤„ ì´ìƒ ì¶œë ¥í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.

## ê¸°ë³¸ ì¶”ì¶œ ê·œì¹™
1. **í•µì‹¬ í‘œí˜„ë§Œ ì¶”ì¶œ**:
   - ë°•ìŠ¤, í…Œì´ë¸”, ë¦¬ìŠ¤íŠ¸ ì•ˆì˜ í•µì‹¬ í‘œí˜„ë§Œ ì¶”ì¶œ
   - ì§§ì€ ë‹¨ì–´/êµ¬/ë¬¸ì¥ë§Œ ì¶”ì¶œ (ê¸´ ë¬¸ë‹¨ ì œì™¸)

2. **ì œì™¸ í•­ëª©**:
   - í˜ì´ì§€ ì œëª©, ì„¹ì…˜ í—¤ë” (Day 01, Unit 01 ë“±)
   - ê¸´ ì„¤ëª… ë¬¸ë‹¨, ë¶€ì—° ì„¤ëª…, Tip ë°•ìŠ¤, ì˜ˆì‹œ ë¬¸ì¥

3. **ì¶œë ¥ í˜•ì‹**:
   - ë²ˆí˜¸ ì—†ì´ "ì˜ì–´:í•œê¸€" í˜•íƒœë§Œ ì¶œë ¥
   - í•œ ì¤„ì— í•˜ë‚˜ì”©

ì˜ˆì‹œ ì¶œë ¥:
get a message:ë©”ì‹œì§€ë¥¼ ë°›ë‹¤
get a text:ë¬¸ìë¥¼ ë°›ë‹¤`;

                formData.append('prompt', customPrompt);

                const response = await fetch('/api/rounds/extract-words', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('ë‹¨ì–´ ì¶”ì¶œ ì‹¤íŒ¨');

                const data = await response.json();
                const extractedWords = data.words || [];

                if (extractedWords.length === 0) {
                    alert('ì¶”ì¶œëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì¶”ì¶œëœ ë‹¨ì–´ë¥¼ ìˆ˜ë™ ì…ë ¥ì°½ì— ì¶”ê°€ (Dynamic Input Rows)
                const list = document.getElementById('manualInputList');

                // ë§Œì•½ ì²« ë²ˆì§¸ í–‰ì´ ë¹„ì–´ìˆë‹¤ë©´ ê±°ê¸°ë¶€í„° ì±„ì›€
                const existingRows = list.querySelectorAll('.manual-input-row');
                let startNewRow = true;

                if (existingRows.length === 1) {
                    const firstRowInputs = existingRows[0].querySelectorAll('input');
                    if (!firstRowInputs[0].value.trim() && !firstRowInputs[1].value.trim()) {
                        startNewRow = false; // Reuse the first empty row
                        // We will remove it later or just populate it? 
                        // Easier: remove empty rows before adding? 
                        // Logic: Loop through extracted words, addInputRow(), populate.
                    }
                }

                extractedWords.forEach(wordLine => {
                    // addInputRow creates an empty row at the end
                    addInputRow();

                    // Get the last added row
                    const rows = list.querySelectorAll('.manual-input-row');
                    const lastRow = rows[rows.length - 1];
                    const inputs = lastRow.querySelectorAll('input');
                    const englishInput = inputs[0];
                    const koreanInput = inputs[1];

                    // Parse "English:Korean"
                    if (wordLine.includes(':')) {
                        const parts = wordLine.split(':');
                        englishInput.value = parts[0].trim();
                        // Join the rest back in case the meaning has colons
                        koreanInput.value = parts.slice(1).join(':').trim();
                    } else {
                        englishInput.value = wordLine.trim();
                    }
                });

                // Remove the initial empty row if it existed and was empty?
                // Actually, let's keep it simple. Just append. Users can delete empty rows if needed.
                // Or better: clear the list ONLY if it has one empty row at start?
                // Let's refine the logic:
                // If only 1 row exists and is empty, remove it before adding new ones.
                if (existingRows.length === 1) {
                    const firstInputs = existingRows[0].querySelectorAll('input');
                    if (!firstInputs[0].value.trim() && !firstInputs[1].value.trim()) {
                        existingRows[0].remove();
                    }
                }

                // ì´ë¯¸ì§€ ì´ˆê¸°í™”
                fileInput.value = '';
                document.getElementById('imagePreviewArea').innerHTML = '';

                alert(`${extractedWords.length}ê°œ ë‹¨ì–´ê°€ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ í›„ "ë‹¨ì–´ ì €ì¥" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
            } catch (error) {
                console.error('Failed to extract words:', error);
                alert('ë‹¨ì–´ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ===== ë¬¸ì œ ìƒì„± =====
        async function generateQuestionsFromVocabulary() {
            showLoading();

            try {
                // í˜„ì¬ ë‹¨ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const vocabRes = await fetch(`/api/rounds/${currentRoundId}/vocabulary`);
                const vocabulary = await vocabRes.json();

                if (!vocabulary || vocabulary.length === 0) {
                    alert('ë¨¼ì € ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    hideLoading();
                    return;
                }

                // --- ë¬¸ì œ ìˆ˜ ë° ë‹¨ì–´ ì„ íƒ ---
                const questionCount = parseInt(document.getElementById('questionCount').value) || 30;
                // 1. Shuffle
                const shuffled = [...vocabulary].sort(() => 0.5 - Math.random());
                // 2. Slice top N (based on questionCount)
                const selectedVocab = shuffled.slice(0, questionCount);

                const words = selectedVocab.map(v => `${v.english}:${v.korean || ''}`);
                const wordListStr = words.join('\n');
                const difficulty = document.getElementById('difficultyValue').value;

                const prompts = {
                    'EASY': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ **ê°ê´€ì‹ ë¬¸ì œë§Œ** ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ëœ»",
    "answer": "ì •ë‹µ ì˜ì–´ ë‹¨ì–´",
    "answerType": "CHOICE",
    "options": ["ì˜¤ë‹µ1", "ì˜¤ë‹µ2", "ì˜¤ë‹µ3"]
  }
]

ê·œì¹™:
1. ëª¨ë“  ë¬¸ì œëŠ” ê°ê´€ì‹ì…ë‹ˆë‹¤.
2. optionsì—ëŠ” ì •ë‹µê³¼ ë¹„ìŠ·í•œ ì˜¤ë‹µ 3ê°œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
3. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`,

                    'MEDIUM': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ **ì£¼ê´€ì‹ ë¬¸ì œë§Œ** ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ëœ»",
    "answer": "ì •ë‹µ ì˜ì–´ ë‹¨ì–´",
    "answerType": "TEXT",
    "options": []
  }
]

ê·œì¹™:
1. **ëª¨ë“  ë¬¸ì œëŠ” ì£¼ê´€ì‹(TEXT)ì…ë‹ˆë‹¤.**
2. **ì§ˆë¬¸(questionText)ì€ ë°˜ë“œì‹œ 'í•œê¸€ ëœ»'**ìœ¼ë¡œ ì£¼ì„¸ìš”.
3. **ì •ë‹µ(answer)ì€ ë°˜ë“œì‹œ 'ì˜ì–´ ë‹¨ì–´'**ë¡œ ì£¼ì„¸ìš”.
4. optionsëŠ” ë¹ˆ ë°°ì—´([])ë¡œ ë‘ì„¸ìš”.
5. **ì£¼ì–´ì§„ ë‹¨ì–´ ëª©ë¡ì—ì„œ ëœë¤ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ì •í™•íˆ ${questionCount}ê°œì˜ ë¬¸ì œë¥¼ ìƒì„±í•˜ì„¸ìš”. ${questionCount}ê°œë³´ë‹¤ ì ê±°ë‚˜ ë§ìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤.**
6. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`,

                    'HARD': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ **ì‘ìš©í•œ ê°„ë‹¨í•œ ì˜ì–´ ë¬¸ì¥ ë¬¸ì œ**ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ë¬¸ì¥ (ë²ˆì—­í•  ë¬¸ì¥)",
    "answer": "ì •ë‹µ ì˜ì–´ ë¬¸ì¥",
    "answerType": "TEXT",
    "options": []
  }
]

ê·œì¹™:
1. ëª¨ë“  ë¬¸ì œëŠ” ì£¼ê´€ì‹ì…ë‹ˆë‹¤.
2. ë‹¨ì–´ë“¤ì„ í™œìš©í•œ ê°„ë‹¨í•œ ë¬¸ì¥ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
3. optionsëŠ” ë¹ˆ ë°°ì—´ë¡œ ë‘ì„¸ìš”.
4. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`
                };

                const prompt = prompts[difficulty] || prompts['MEDIUM'];

                const generateResponse = await fetch(`/api/rounds/${currentRoundId}/generate-from-words`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        words: words,
                        difficulty: difficulty,
                        prompt: prompt,
                        passScore: parseInt(document.getElementById('passScore').value) || 24
                    })
                });

                if (!generateResponse.ok) throw new Error('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨');

                const result = await generateResponse.json();
                alert(`${result.count}ê°œì˜ ë¬¸ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);

                // íšŒì°¨ ì •ë³´ ìƒˆë¡œê³ ì¹¨
                viewRoundDetail(currentRoundId);
            } catch (error) {
                console.error('Failed to generate questions:', error);
                alert('ë¬¸ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ===== íšŒì°¨ ì‚­ì œ =====
        async function deleteCurrentRound() {
            if (!currentRoundId) {
                alert('ì‚­ì œí•  íšŒì°¨ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ì •ë§ ì´ íšŒì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showLoading();
            try {
                await fetch(`/api/rounds/${currentRoundId}`, { method: 'DELETE' });
                alert('íšŒì°¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                showAdminSection();
            } catch (error) {
                console.error('Failed to delete round:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        // ===== íƒ­ ì „í™˜ =====
        function switchTab(tabName, clickedBtn) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (clickedBtn) clickedBtn.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });

            if (tabName === 'vocabulary') {
                document.getElementById('vocabularyTab').classList.remove('hidden');
                document.getElementById('vocabularyTab').classList.add('active');
            } else if (tabName === 'materials') {
                document.getElementById('materialsTab').classList.remove('hidden');
                document.getElementById('materialsTab').classList.add('active');
                loadMaterials();
            }
        }

        // ===== êµìœ¡ìë£Œ ê´€ë¦¬ =====
        async function loadMaterials() {
            if (!currentRoundId) return;

            try {
                const response = await fetch(`/api/rounds/${currentRoundId}/materials`);
                const materials = await response.json();

                const listHtml = materials.length === 0
                    ? '<p class="empty-message">ë“±ë¡ëœ êµìœ¡ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    : materials.map(m => {
                        const icon = m.materialType === 'YOUTUBE' ? 'ğŸ“º' : 'ğŸ“„';
                        const isPdf = m.fileName && m.fileName.toLowerCase().endsWith('.pdf');
                        const previewHtml = isPdf
                            ? `<div class="pdf-preview" style="margin-top:15px; width:100%; height:600px; border-radius:10px; overflow:hidden; box-shadow: inset 2px 2px 5px #babecc, inset -5px -5px 10px #ffffff;">
                                 <iframe src="${m.url}#view=FitH" style="width:100%; height:100%; border:none;"></iframe>
                               </div>`
                            : '';

                        return `
                            <div class="material-card" style="flex-direction: column; align-items: flex-start;">
                                <div style="display:flex; width:100%; align-items:center; justify-content:space-between;">
                                    <div style="display:flex; align-items:center; gap:15px;">
                                        <span class="material-icon">${icon}</span>
                                        <div class="material-info">
                                            <div class="material-title">${m.title || (m.materialType === 'YOUTUBE' ? 'ìœ íŠœë¸Œ ì˜ìƒ' : 'ìë£Œ')}</div>
                                            <div class="material-url">${m.materialType === 'YOUTUBE' ? m.url : m.fileName}</div>
                                        </div>
                                    </div>
                                    <button onclick="deleteMaterial(${m.id})" class="btn-danger btn-small">ì‚­ì œ</button>
                                </div>
                                ${previewHtml}
                            </div>
                        `;
                    }).join('');

                document.getElementById('materialsList').innerHTML = listHtml;
            } catch (error) {
                console.error('Failed to load materials:', error);
            }
        }

        async function addYoutubeMaterial() {
            const title = document.getElementById('youtubeTitle').value.trim();
            const url = document.getElementById('youtubeUrl').value.trim();

            if (!url) {
                alert('ìœ íŠœë¸Œ URLì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/rounds/${currentRoundId}/materials/youtube`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, url })
                });

                if (!response.ok) throw new Error('ì¶”ê°€ ì‹¤íŒ¨');

                document.getElementById('youtubeTitle').value = '';
                document.getElementById('youtubeUrl').value = '';
                loadMaterials();
                alert('ìœ íŠœë¸Œ ì˜ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Failed to add youtube:', error);
                alert('ìœ íŠœë¸Œ ì˜ìƒ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        async function addPptMaterial() {
            const title = document.getElementById('pptTitle').value.trim();
            const fileInput = document.getElementById('pptFile');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            showLoading();
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                if (title) formData.append('title', title);

                const response = await fetch(`/api/rounds/${currentRoundId}/materials/ppt`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');

                document.getElementById('pptTitle').value = '';
                fileInput.value = '';
                updatePptFileName('');
                loadMaterials();
                alert('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Failed to upload ppt:', error);
                alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        async function deleteMaterial(id) {
            if (!confirm('ì´ ìë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showLoading();
            try {
                await fetch(`/api/materials/${id}`, { method: 'DELETE' });
                loadMaterials();
            } catch (error) {
                console.error('Failed to delete material:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        async function deleteWord(id) {
            if (!confirm('ì´ ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showLoading();
            try {
                const response = await fetch(`/api/vocabulary/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');

                // Refresh list
                const vocabRes = await fetch(`/api/rounds/${currentRoundId}/vocabulary`);
                const vocabulary = await vocabRes.json();
                renderVocabularyList(vocabulary);
            } catch (error) {
                console.error('Failed to delete word:', error);
                alert('ë‹¨ì–´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        function updatePptFileName(fileName) {
            const el = document.getElementById('pptFileName');
            if (el) {
                el.textContent = fileName ? `ğŸ“ ${fileName}` : '';
            }
        }

        // ===== ë“œë˜ê·¸ ì•¤ ë“œë¡­ =====
        document.addEventListener('DOMContentLoaded', function () {
            setupDragDrop('imageDropZone', 'wordImages', function (files) {
                const input = document.getElementById('wordImages');
                const dt = new DataTransfer();
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        dt.items.add(file);
                    }
                }
                input.files = dt.files;
                previewImages(input);
            });

            setupDragDrop('pptDropZone', 'pptFile', function (files) {
                const input = document.getElementById('pptFile');
                if (files.length > 0) {
                    if (files[0].type !== 'application/pdf' && !files[0].name.toLowerCase().endsWith('.pdf')) {
                        alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        return;
                    }
                    const dt = new DataTransfer();
                    dt.items.add(files[0]);
                    input.files = dt.files;
                    updatePptFileName(files[0].name);
                }
            });

            document.getElementById('pptFile')?.addEventListener('change', function () {
                if (this.files.length > 0) {
                    updatePptFileName(this.files[0].name);
                } else {
                    updatePptFileName('');
                }
            });
        });

        function setupDragDrop(dropZoneId, inputId, onDropCallback) {
            const dropZone = document.getElementById(dropZoneId);
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) onDropCallback(files);
            }, false);
        }
    </script>
</body>

</html>