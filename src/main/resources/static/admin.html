<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ì˜ì–´ ì‹œí—˜ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css?v=3">
</head>

<body>
    <div class="app-layout">
        <div id="sidebarOverlay" class="sidebar-overlay hidden" onclick="toggleSidebar()"></div>
        <nav class="sidebar hidden" id="mainSidebar">
            <div class="sidebar-header">
                <div class="logo-area" onclick="location.href='/'">
                    <div class="logo-icon"><i class="fa-solid fa-layer-group"></i></div>
                    <div class="logo-text">
                        <h2>EstellExam</h2><span class="badge"
                            style="background:var(--primary); color:white;">Admin</span>
                    </div>
                </div>
            </div>
            <ul class="nav-links">
                <li class="nav-item active" onclick="location.reload()"><i
                        class="fa-solid fa-gear"></i><span>Dashboard</span></li>
                <li class="nav-item" onclick="location.href='/'"><i class="fa-solid fa-house"></i><span>Main Site</span>
                </li>
            </ul>
        </nav>
        <main class="main-content">
            <header class="top-header" style="flex-wrap: nowrap;">
                <div class="header-title" style="display:flex; align-items:center; gap:10px;">
                    <button class="clay-btn btn-secondary btn-small hidden" id="headerCloseBtn"
                        onclick="location.href='/'"><i class="fa-solid fa-arrow-left"></i> Close</button>
                    <div class="header-left-mobile mobile-only"
                        style="display:none; align-items:center; gap:10px; margin-right:10px;">
                        <i class="fa-solid fa-bars" style="font-size:1.1rem; cursor:pointer; color:var(--text-main);"
                            onclick="toggleSidebar()"></i>
                        <div class="logo-area-mobile"
                            style="font-size:1rem; font-weight:900; color:var(--text-main); display:flex; align-items:center; gap:8px;">
                            <i class="fa-solid fa-layer-group" style="color:var(--primary);"></i><span>Admin</span>
                        </div>
                    </div>
                </div>
                <div class="header-right" style="display:flex; align-items:center; gap:20px;">
                    <!-- Dark Mode Toggle -->
                    <div class="theme-toggle-header" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <i id="themeIcon" class="fa-solid fa-moon"></i>
                    </div>

                    <!-- User Profile Dropdown -->
                    <div class="user-profile-container" id="userProfileArea">
                        <div class="user-profile" onclick="toggleProfileMenu(event)">
                            <div class="avatar-circle">
                                <i class="fa-solid fa-user-shield"></i>
                            </div>
                            <span id="headerUserName" class="pc-only">Admin</span>
                            <i class="fa-solid fa-caret-down"></i>
                        </div>

                        <div class="profile-dropdown hidden" id="profileDropdown">
                            <div class="dropdown-item" onclick="location.href='/'">
                                <i class="fa-solid fa-right-from-bracket" style="color: var(--danger);"></i> Exit
                            </div>
                        </div>
                    </div>

                    <!-- Close Button (Original Style from index.html) -->
                    <a href="/" class="clay-btn btn-secondary btn-small"
                        style="text-decoration:none; display:flex; align-items:center; gap:8px;">
                        <i class="fa-solid fa-arrow-left"></i>
                        <span>Close</span>
                    </a>
                </div>
            </header>
            <div class="container" style="padding-top:20px;">
                <main id="mainContent">
                    <!-- ê´€ë¦¬ì ë©”ì¸ -->
                    <div id="adminSection" class="section">
                        <div class="admin-actions">
                            <button onclick="showCreateRound()" class="btn-primary">ìƒˆ íšŒì°¨ ìƒì„±</button>
                        </div>
                        <div id="adminRoundList" class="round-list"></div>
                    </div>

                    <!-- íšŒì°¨ ìƒì„± - 1ë‹¨ê³„: ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                    <div id="uploadImagesSection" class="section hidden">
                        <div class="section-header">
                            <h2>1ë‹¨ê³„: ë‹¨ì–´ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
                            <button onclick="showAdminSection()" class="btn-secondary">ë’¤ë¡œ</button>
                        </div>
                        <div class="form-group">
                            <label>íšŒì°¨ ì œëª©</label>
                            <input type="text" id="roundTitle" placeholder="ì˜ˆ: 1íšŒì°¨ ë‹¨ì–´ ì‹œí—˜">
                        </div>
                        <div class="form-group">
                            <label>ì„¤ëª…</label>
                            <textarea id="roundDescription" placeholder="ì‹œí—˜ì— ëŒ€í•œ ì„¤ëª…"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ë‚œì´ë„</label>
                            <select id="difficulty">
                                <option value="EASY">ì‰¬ì›€ (ê°ê´€ì‹ 100%)</option>
                                <option value="MEDIUM" selected>ë³´í†µ (ê°ê´€ì‹ 30% + ì£¼ê´€ì‹ 70%)</option>
                                <option value="HARD">ì–´ë ¤ì›€ (ë¬¸ì¥ ì‘ìš© - ì£¼ê´€ì‹)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ë‹¨ì–´ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="wordImages" accept="image/*" multiple
                                    onchange="previewImages(this)" class="hidden-file-input">
                                <label for="wordImages" class="file-upload-label clay-card-upload" id="imageDropZone">
                                    <div class="upload-icon-circle">
                                        <i class="fa-solid fa-cloud-arrow-up"></i>
                                    </div>
                                    <span class="upload-primary-text">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span>
                                    <span class="upload-secondary-text">ë˜ëŠ” íŒŒì¼ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                                </label>
                            </div>
                            <div id="imagePreviewArea" class="image-preview-area"></div>
                        </div>
                        <button onclick="extractWords()" class="btn-primary btn-large">ë‹¨ì–´ ì¶”ì¶œí•˜ê¸°</button>
                        <p class="hint">* ì´ë¯¸ì§€ì—ì„œ ì˜ì–´ ë‹¨ì–´ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
                    </div>

                    <!-- íšŒì°¨ ìƒì„± - 2ë‹¨ê³„: ë‹¨ì–´ í™•ì¸/ìˆ˜ì • -->
                    <div id="reviewWordsSection" class="section hidden">
                        <div class="section-header">
                            <h2>2ë‹¨ê³„: ì¶”ì¶œëœ ë‹¨ì–´ í™•ì¸</h2>
                            <button onclick="showUploadImages()" class="btn-secondary">ë’¤ë¡œ</button>
                        </div>
                        <p class="hint">ì¶”ì¶œëœ ë‹¨ì–´ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”. ê° ì¤„ì— í•˜ë‚˜ì”©, "ì˜ì–´:í•œê¸€" í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•©ë‹ˆë‹¤.</p>
                        <div class="form-group">
                            <textarea id="extractedWords" rows="15" placeholder="apple:ì‚¬ê³¼&#10;banana:ë°”ë‚˜ë‚˜"></textarea>
                        </div>
                        <button onclick="generateQuestions()" class="btn-success btn-large">ë¬¸ì œ ìƒì„±í•˜ê¸°</button>
                    </div>

                    <!-- íšŒì°¨ ìƒì„¸ ë³´ê¸° -->
                    <div id="roundDetailSection" class="section hidden">
                        <div class="section-header">
                            <h2 id="roundDetailTitle">íšŒì°¨ ìƒì„¸</h2>
                            <button onclick="showAdminSection()" class="btn-secondary">ë’¤ë¡œ</button>
                        </div>

                        <!-- íƒ­ ë©”ë‰´ -->
                        <div class="tab-menu">
                            <button class="tab-btn active" onclick="switchTab('questions', this)">ë¬¸ì œ ëª©ë¡</button>
                            <button class="tab-btn" onclick="switchTab('materials', this)">êµìœ¡ìë£Œ</button>
                        </div>

                        <!-- ë¬¸ì œ ëª©ë¡ íƒ­ -->
                        <div id="questionsTab" class="tab-content active">
                            <div id="roundQuestionsList" class="questions-list"></div>
                        </div>

                        <!-- êµìœ¡ìë£Œ íƒ­ -->
                        <div id="materialsTab" class="tab-content hidden">
                            <!-- ìœ íŠœë¸Œ ì˜ìƒ ì¶”ê°€ -->
                            <div class="material-add-section">
                                <h3>ğŸ“º ìœ íŠœë¸Œ ì˜ìƒ ì¶”ê°€</h3>
                                <div class="form-row">
                                    <input type="text" id="youtubeTitle" placeholder="ì˜ìƒ ì œëª© (ì„ íƒ)">
                                    <input type="text" id="youtubeUrl" placeholder="ìœ íŠœë¸Œ URL">
                                    <button type="button" onclick="addYoutubeMaterial()" class="btn-primary">ì¶”ê°€</button>
                                </div>
                            </div>

                            <!-- PPT ìë£Œ ì—…ë¡œë“œ -->
                            <div class="material-add-section">
                                <h3>ğŸ“„ PDF ìë£Œ ì—…ë¡œë“œ</h3>
                                <input type="text" id="pptTitle" placeholder="ìë£Œ ì œëª© (ì„ íƒ)" class="clay-input"
                                    style="margin-bottom: 15px;">
                                <div class="file-upload-wrapper">
                                    <input type="file" id="pptFile" accept=".pdf" class="hidden-file-input">
                                    <label for="pptFile" class="file-upload-label clay-card-upload" id="pptDropZone">
                                        <div class="upload-icon-circle">
                                            <i class="fa-solid fa-file-arrow-up"></i>
                                        </div>
                                        <span class="upload-primary-text">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</span>
                                        <span class="upload-secondary-text">ë˜ëŠ” íŒŒì¼ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ì„¸ìš”</span>
                                        <span class="upload-file-name" id="pptFileName"></span>
                                    </label>
                                </div>
                                <button type="button" onclick="addPptMaterial()" class="btn-primary"
                                    style="margin-top: 15px; width: 100%;">ì—…ë¡œë“œ</button>
                            </div>

                            <!-- ë“±ë¡ëœ êµìœ¡ìë£Œ ëª©ë¡ -->
                            <div class="material-list-section">
                                <h3>ğŸ“‹ ë“±ë¡ëœ êµìœ¡ìë£Œ</h3>
                                <div id="materialsList"></div>
                            </div>
                        </div>

                        <div class="admin-actions">
                            <button onclick="deleteCurrentRound()" class="btn-danger">íšŒì°¨ ì‚­ì œ</button>
                        </div>
                    </div>
                </main>
            </div>
        </main>
    </div>

    <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <p>ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <script>
        // Layout Utilities
        function toggleSidebar() {
            const sb = document.getElementById('mainSidebar'); if (sb) sb.classList.toggle('active');
            const ov = document.getElementById('sidebarOverlay'); if (ov) ov.classList.toggle('hidden');
        }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }
        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            if (document.body.classList.contains('dark-mode')) { icon.className = 'fa-solid fa-sun'; icon.style.color = '#fbbf24'; }
            else { icon.className = 'fa-solid fa-moon'; icon.style.color = ''; }
        }
        function toggleProfileMenu(e) {
            if (e) e.stopPropagation();
            document.getElementById('profileDropdown').classList.toggle('hidden');
        }
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); updateThemeIcon(); }
            window.addEventListener('click', (e) => {
                const dd = document.getElementById('profileDropdown');
                const pa = document.getElementById('userProfileArea');
                if (dd && !dd.classList.contains('hidden') && pa && !pa.contains(e.target)) dd.classList.add('hidden');
            });
        });

        // ê´€ë¦¬ì í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸
        let currentRoundId = null;
        let extractedWordsList = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íšŒì°¨ ëª©ë¡ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', loadAdminRounds);

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showAdminSection() {
            showSection('adminSection');
            loadAdminRounds();
        }

        function showCreateRound() {
            showSection('uploadImagesSection');
            document.getElementById('roundTitle').value = '';
            document.getElementById('roundDescription').value = '';
            document.getElementById('wordImages').value = '';
            document.getElementById('imagePreviewArea').innerHTML = '';
        }

        function showUploadImages() {
            showSection('uploadImagesSection');
        }

        async function loadAdminRounds() {
            try {
                const response = await fetch('/api/rounds');
                const rounds = await response.json();

                const listHtml = rounds.length === 0
                    ? '<p class="empty-message">ìƒì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    : rounds.map(r => `
                        <div class="round-card" onclick="viewRoundDetail(${r.id})">
                            <h3>${r.title}</h3>
                            <p>${r.description || ''}</p>
                            <div class="round-meta">
                                <span>ë¬¸ì œ ìˆ˜: ${r.questionCount}</span>
                                <span>ë‚œì´ë„: ${r.difficulty}</span>
                                <span class="status-badge ${r.status.toLowerCase()}">${r.status}</span>
                            </div>
                        </div>
                    `).join('');

                document.getElementById('adminRoundList').innerHTML = listHtml;
            } catch (error) {
                console.error('Failed to load rounds:', error);
            }
        }

        function previewImages(input) {
            const previewArea = document.getElementById('imagePreviewArea');
            previewArea.innerHTML = '';

            if (input.files && input.files.length > 0) {
                for (const file of input.files) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.classList.add('preview-image');
                        previewArea.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function () {
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë“œë˜ê·¸ ì•¤ ë“œë¡­
            setupDragDrop('imageDropZone', 'wordImages', function (files) {
                const input = document.getElementById('wordImages');
                const dt = new DataTransfer();
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        dt.items.add(file);
                    }
                }
                input.files = dt.files;
                previewImages(input);
            });

            // PPT/PDF ì—…ë¡œë“œ ë“œë˜ê·¸ ì•¤ ë“œë¡­
            setupDragDrop('pptDropZone', 'pptFile', function (files) {
                const input = document.getElementById('pptFile');
                if (files.length > 0) {
                    // PDF íŒŒì¼ ê²€ì‚¬
                    if (files[0].type !== 'application/pdf' && !files[0].name.toLowerCase().endsWith('.pdf')) {
                        alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        return;
                    }

                    const dt = new DataTransfer();
                    dt.items.add(files[0]); // ì²« ë²ˆì§¸ íŒŒì¼ë§Œ
                    input.files = dt.files;
                    updatePptFileName(files[0].name);
                }
            });

            // PPT íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ëª… í‘œì‹œ
            document.getElementById('pptFile').addEventListener('change', function () {
                if (this.files.length > 0) {
                    updatePptFileName(this.files[0].name);
                } else {
                    updatePptFileName('');
                }
            });
        });

        function setupDragDrop(dropZoneId, inputId, onDropCallback) {
            const dropZone = document.getElementById(dropZoneId);
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('drag-over');
                }, false);
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    onDropCallback(files);
                }
            }, false);
        }

        function updatePptFileName(fileName) {
            const el = document.getElementById('pptFileName');
            if (el) {
                el.textContent = fileName ? `ğŸ“ ${fileName}` : '';
            }
        }

        async function extractWords() {
            const title = document.getElementById('roundTitle').value.trim();
            const fileInput = document.getElementById('wordImages');

            if (!title) {
                alert('íšŒì°¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            showLoading();

            try {
                const formData = new FormData();
                for (const file of fileInput.files) {
                    formData.append('images', file);
                }

                // ìˆ¨ê²¨ì§„ í”„ë¡¬í”„íŠ¸ ì •ì˜
                const customPrompt = `ë‹¹ì‹ ì€ ì˜ì–´ í•™ìŠµ êµì¬ì—ì„œ ì˜ì–´ í‘œí˜„ì„ ì¶”ì¶œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì´ë¯¸ì§€ì—ì„œ ë‹¤ìŒ ê·œì¹™ì— ë”°ë¼ ì˜ì–´ í‘œí˜„ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”:

## ì¶”ì¶œ ê·œì¹™
1. **í•µì‹¬ í‘œí˜„ë§Œ ì¶”ì¶œ**:
   - ë°•ìŠ¤, í…Œì´ë¸”, ë¦¬ìŠ¤íŠ¸ ì•ˆì˜ í•µì‹¬ í‘œí˜„ë§Œ ì¶”ì¶œ
   - "ì˜ì–´í‘œí˜„:í•œê¸€ëœ»" ë˜ëŠ” "ì˜ì–´ë¬¸ì¥:í•œê¸€ë²ˆì—­" í˜•íƒœë¡œ ì¶”ì¶œ
   - ì§§ì€ ë‹¨ì–´/êµ¬/ë¬¸ì¥ë§Œ ì¶”ì¶œ (ê¸´ ë¬¸ë‹¨ ì œì™¸)

2. **ì œì™¸ í•­ëª©**:
   - í˜ì´ì§€ ì œëª©, ì„¹ì…˜ í—¤ë” (Day 01, Unit 01 ë“±)
   - ê¸´ ì„¤ëª… ë¬¸ë‹¨, ë¶€ì—° ì„¤ëª…
   - Tip ë°•ìŠ¤, ë¬¸ë²• ì„¤ëª…
   - ì˜ˆì‹œë¥¼ ì„¤ëª…í•˜ëŠ” ê¸´ ë¬¸ì¥

3. **ì¶œë ¥ í˜•ì‹**:
   - í•œ ì¤„ì— í•˜ë‚˜ì”©
   - "ì˜ì–´:í•œê¸€" í˜•íƒœ
   - ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ì¶”ì¶œëœ ë‚´ìš©ë§Œ
   - ì˜ì–´:í•œê¸€ í˜•íƒœê°€ ì•ˆë˜ëŠ” ê²½ìš° ì¶”ì¶œ ì œì™¸

ì˜ˆì‹œ ì¶œë ¥:
get a message:ë©”ì‹œì§€ë¥¼ ë°›ë‹¤
get a text:ë¬¸ìë¥¼ ë°›ë‹¤
live in:~ì— ì‚´ë‹¤
work in:~ì—ì„œ ì¼í•˜ë‹¤`;

                formData.append('prompt', customPrompt);

                const response = await fetch('/api/rounds/extract-words', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('ë‹¨ì–´ ì¶”ì¶œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                extractedWordsList = data.words || [];

                document.getElementById('extractedWords').value = extractedWordsList.join('\n');
                showSection('reviewWordsSection');
            } catch (error) {
                console.error('Failed to extract words:', error);
                alert('ë‹¨ì–´ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function generateQuestions() {
            const title = document.getElementById('roundTitle').value.trim();
            const description = document.getElementById('roundDescription').value.trim();
            const difficulty = document.getElementById('difficulty').value;
            const wordsText = document.getElementById('extractedWords').value.trim();

            if (!wordsText) {
                alert('ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const words = wordsText.split('\n').filter(w => w.trim());

            showLoading();

            try {
                // 1. íšŒì°¨ ìƒì„±
                const roundResponse = await fetch('/api/rounds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        questionCount: words.length,
                        difficulty: difficulty,
                        status: 'ACTIVE'
                    })
                });

                if (!roundResponse.ok) {
                    throw new Error('íšŒì°¨ ìƒì„± ì‹¤íŒ¨');
                }

                const round = await roundResponse.json();

                // 2. ë‹¨ì–´ ê¸°ë°˜ ë¬¸ì œ ìƒì„±
                const wordListStr = words.join('\n');

                // ë‚œì´ë„ë³„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì •ì˜
                const prompts = {
                    'EASY': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ **ê°ê´€ì‹ ë¬¸ì œë§Œ** ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ëœ»",
    "answer": "ì •ë‹µ ì˜ì–´ ë‹¨ì–´",
    "answerType": "CHOICE",
    "options": ["ì˜¤ë‹µ1", "ì˜¤ë‹µ2", "ì˜¤ë‹µ3"]
  }
]

ê·œì¹™:
1. ëª¨ë“  ë¬¸ì œëŠ” ê°ê´€ì‹ì…ë‹ˆë‹¤.
2. optionsì—ëŠ” ì •ë‹µê³¼ ë¹„ìŠ·í•œ ì˜¤ë‹µ 3ê°œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
3. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`,

                    'MEDIUM': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ **ê°ê´€ì‹ 30%, ì£¼ê´€ì‹ 70%** ë¹„ìœ¨ë¡œ ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ëœ» ë˜ëŠ” ë¬¸ì¥",
    "answer": "ì •ë‹µ ì˜ì–´",
    "answerType": "CHOICE" ë˜ëŠ” "TEXT",
    "options": ["ì˜¤ë‹µ1", "ì˜¤ë‹µ2", "ì˜¤ë‹µ3"] (ê°ê´€ì‹ì¼ ë•Œë§Œ)
  }
]

ê·œì¹™:
1. ê°ê´€ì‹(CHOICE)ê³¼ ì£¼ê´€ì‹(TEXT)ë¥¼ ì„ì–´ì£¼ì„¸ìš”.
2. ì£¼ê´€ì‹ì€ optionsë¥¼ ë¹ˆ ë°°ì—´ë¡œ ë‘ì„¸ìš”.
3. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`,

                    'HARD': `ë‹¹ì‹ ì€ ì˜ì–´ ì‹œí—˜ ë¬¸ì œ ì¶œì œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¨ì–´ë“¤ì„ **ì‘ìš©í•œ ê°„ë‹¨í•œ ì˜ì–´ ë¬¸ì¥ ë¬¸ì œ**ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¨ì–´ ëª©ë¡:
${wordListStr}

ì‘ë‹µ í˜•ì‹ (JSON ë°°ì—´):
[
  {
    "questionText": "í•œê¸€ ë¬¸ì¥ (ë²ˆì—­í•  ë¬¸ì¥)",
    "answer": "ì •ë‹µ ì˜ì–´ ë¬¸ì¥",
    "answerType": "TEXT",
    "options": []
  }
]

ê·œì¹™:
1. ëª¨ë“  ë¬¸ì œëŠ” ì£¼ê´€ì‹ì…ë‹ˆë‹¤.
2. ë‹¨ì–´ë“¤ì„ í™œìš©í•œ ê°„ë‹¨í•œ ë¬¸ì¥ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
3. optionsëŠ” ë¹ˆ ë°°ì—´ë¡œ ë‘ì„¸ìš”.
4. JSON í˜•ì‹ë§Œ ì‘ë‹µí•˜ì„¸ìš”.`
                };

                const prompt = prompts[difficulty] || prompts['MEDIUM'];

                const generateResponse = await fetch(`/api/rounds/${round.id}/generate-from-words`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        words: words,
                        difficulty: difficulty,
                        prompt: prompt
                    })
                });

                if (!generateResponse.ok) {
                    throw new Error('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨');
                }

                const result = await generateResponse.json();
                alert(`${result.count}ê°œì˜ ë¬¸ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);

                showAdminSection();
            } catch (error) {
                console.error('Failed to generate questions:', error);
                alert('ë¬¸ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function viewRoundDetail(roundId) {
            currentRoundId = roundId;
            showLoading();

            try {
                const [roundRes, questionsRes] = await Promise.all([
                    fetch(`/api/rounds/${roundId}`),
                    fetch(`/api/rounds/${roundId}/questions`)
                ]);

                const round = await roundRes.json();
                const questions = await questionsRes.json();

                document.getElementById('roundDetailTitle').textContent = round.title;

                const questionsHtml = questions.length === 0
                    ? '<p class="empty-message">ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    : questions.map((q, i) => `
                        <div class="question-card">
                            <div class="question-number">${i + 1}ë²ˆ</div>
                            <div class="question-content">
                                <p class="question-text">${q.questionText}</p>
                                <p class="answer"><strong>ì •ë‹µ:</strong> ${q.answer}</p>
                                ${q.answerType === 'CHOICE' ? `
                                    <div class="options">
                                        <span>â‘  ${q.option1 || ''}</span>
                                        <span>â‘¡ ${q.option2 || ''}</span>
                                        <span>â‘¢ ${q.option3 || ''}</span>
                                        <span>â‘£ ${q.option4 || ''}</span>
                                    </div>
                                ` : '<span class="badge">ì£¼ê´€ì‹</span>'}
                            </div>
                        </div>
                    `).join('');

                document.getElementById('roundQuestionsList').innerHTML = questionsHtml;
                showSection('roundDetailSection');
            } catch (error) {
                console.error('Failed to load round detail:', error);
            } finally {
                hideLoading();
            }
        }

        async function deleteCurrentRound() {
            if (!currentRoundId) {
                alert('ì‚­ì œí•  íšŒì°¨ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ì •ë§ ì´ íšŒì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showLoading();

            try {
                await fetch(`/api/rounds/${currentRoundId}`, { method: 'DELETE' });
                alert('íšŒì°¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                showAdminSection();
            } catch (error) {
                console.error('Failed to delete round:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        // ===== íƒ­ ì „í™˜ =====
        function switchTab(tabName, clickedBtn) {
            // íƒ­ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (clickedBtn) clickedBtn.classList.add('active');

            // íƒ­ ë‚´ìš© í‘œì‹œ/ìˆ¨ê¹€
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });

            if (tabName === 'questions') {
                document.getElementById('questionsTab').classList.remove('hidden');
                document.getElementById('questionsTab').classList.add('active');
            } else if (tabName === 'materials') {
                document.getElementById('materialsTab').classList.remove('hidden');
                document.getElementById('materialsTab').classList.add('active');
                loadMaterials();
            }
        }

        // ===== êµìœ¡ìë£Œ ê´€ë¦¬ =====
        async function loadMaterials() {
            if (!currentRoundId) return;

            try {
                const response = await fetch(`/api/rounds/${currentRoundId}/materials`);
                const materials = await response.json();

                const listHtml = materials.length === 0
                    ? '<p class="empty-message">ë“±ë¡ëœ êµìœ¡ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    : materials.map(m => {
                        const icon = m.materialType === 'YOUTUBE' ? 'ğŸ“º' : 'ğŸ“„';
                        const displayUrl = m.materialType === 'YOUTUBE'
                            ? getYoutubeThumbnail(m.url)
                            : m.fileName || m.url;
                        const isPdf = m.fileName && m.fileName.toLowerCase().endsWith('.pdf');
                        const previewHtml = isPdf
                            ? `<div class="pdf-preview" style="margin-top:15px; width:100%; height:600px; border-radius:10px; overflow:hidden; box-shadow: inset 2px 2px 5px #babecc, inset -5px -5px 10px #ffffff;">
                                 <iframe src="${m.url}#view=FitH" style="width:100%; height:100%; border:none;"></iframe>
                               </div>`
                            : '';

                        return `
                            <div class="material-card" style="flex-direction: column; align-items: flex-start;">
                                <div style="display:flex; width:100%; align-items:center; justify-content:space-between;">
                                    <div style="display:flex; align-items:center; gap:15px;">
                                        <span class="material-icon">${icon}</span>
                                        <div class="material-info">
                                            <div class="material-title">${m.title || (m.materialType === 'YOUTUBE' ? 'ìœ íŠœë¸Œ ì˜ìƒ' : 'ìë£Œ')}</div>
                                            <div class="material-url">${m.materialType === 'YOUTUBE' ? m.url : m.fileName}</div>
                                        </div>
                                    </div>
                                    <button onclick="deleteMaterial(${m.id})" class="btn-danger btn-small">ì‚­ì œ</button>
                                </div>
                                ${previewHtml}
                            </div>
                        `;
                    }).join('');

                document.getElementById('materialsList').innerHTML = listHtml;
            } catch (error) {
                console.error('Failed to load materials:', error);
            }
        }

        function getYoutubeThumbnail(url) {
            const videoId = extractYoutubeId(url);
            return videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : '';
        }

        function extractYoutubeId(url) {
            const match = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : null;
        }

        async function addYoutubeMaterial() {
            const title = document.getElementById('youtubeTitle').value.trim();
            const url = document.getElementById('youtubeUrl').value.trim();

            if (!url) {
                alert('ìœ íŠœë¸Œ URLì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/rounds/${currentRoundId}/materials/youtube`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, url })
                });

                if (!response.ok) throw new Error('ì¶”ê°€ ì‹¤íŒ¨');

                document.getElementById('youtubeTitle').value = '';
                document.getElementById('youtubeUrl').value = '';
                loadMaterials();
                alert('ìœ íŠœë¸Œ ì˜ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Failed to add youtube:', error);
                alert('ìœ íŠœë¸Œ ì˜ìƒ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        async function addPptMaterial() {
            const title = document.getElementById('pptTitle').value.trim();
            const fileInput = document.getElementById('pptFile');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            showLoading();
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                if (title) formData.append('title', title);

                const response = await fetch(`/api/rounds/${currentRoundId}/materials/ppt`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');

                document.getElementById('pptTitle').value = '';
                fileInput.value = '';
                loadMaterials();
                alert('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('Failed to upload ppt:', error);
                alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        async function deleteMaterial(id) {
            if (!confirm('ì´ ìë£Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showLoading();
            try {
                await fetch(`/api/materials/${id}`, { method: 'DELETE' });
                loadMaterials();
            } catch (error) {
                console.error('Failed to delete material:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>

</html>